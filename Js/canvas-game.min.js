var camera,SPEED,tileAnimation,saveBg,self,row,column,data,particles=[],snows=[],rains=[],pathIndex=0;get=function(t){return document.querySelector(t)},getAll=function(t){return document.querySelectorAll(t)};var imSet=!1,isCamera=!1,objframe=0,layerframe=0;const log=console.log;var movingSpeed=.5,rotImage=!1,isOnAir=!1;function Stage(){(self={stage:document.createElement("canvas")}).add=function(t,i){this.b=i,void 0==i&&document.body.appendChild(t),void 0!==i&&"before"==i&&document.body.before(t)},self.delete=function(t){document.body.removeChild(t)},self.stage.setBg=function(i){this.c=i,t=this.c||"#123",(void 0==this.c||void 0==i||""==this.c)&&(self.stage.style.background=t),self.stage.style.background=t},window.onload=self.stage.setBg(),self.setSize=function(t,i){this.a=t,this.b=i,this.a&&this.b&&(gW=self.stage.width=this.a,gH=self.stage.height=this.b)},void 0==this.a&&void 0==this.b&&(gW=self.stage.width=600,gH=self.stage.height=400),camera={x:1,y:1,width:self.stage.width,height:self.stage.height},self.stage.setBgRepeat=function(t){self.stage.style.backgroundRepeat=t},ctx=self.stage.getContext("2d",{alpha:!1}),self.setCam=function(t,i,e){if(camera={x:1,y:1,width:gW-1,height:gH-1,color:"red"},void 0==i){ctx.translate(gW/2-t.x-5,gH/2-t.y-5);return}this.debug=e,x=gW/2,y=gH/2,this.debug&&"boolean"==typeof this.debug&&(ctx.strokeStyle=camera.color,ctx.strokeRect(camera.x,camera.y,camera.width,camera.height)),camera.x=t.x+t.w-x,camera.y=t.y+t.h-y,camera.x<=0&&(camera.x=0),camera.y<=0&&(camera.y=0),camera.x>=i.width-camera.width&&(camera.x=i.width-camera.width),camera.y>i.height-camera.height&&(camera.y=i.height-camera.height),t.x>=x&&(ctx.translate(-camera.x,0),isCamera=!0),t.y>=y&&(ctx.translate(0,-camera.y),isCamera=!0),(t.x<x||t.y<y)&&(isCamera=!1)},rectColor=function(t){ctx.fillStyle=t},strokeColor=function(t){ctx.strokeStyle=t},Rect=function(t,i){ctx.fillStyle=this.color,ctx.fillRect(t.x,t.y,t.w,t.h)},Stroke=function(t,i,e,s,h){ctx.strokeStyle=this.color,ctx.strokeRect(t,i,e,s)},playSound=function(t){return this.audio=new Audio(t),this.audio.currentTime=.2,this.audio.volume=.09,this.audio.play(),this},stopSound=function(t){t.audio.pause(),t.currentTime=0},Text=function(t,i,e,s,h,l,a){this.x=l,this.y=a,this.color=t||"gold",this.fontsize=e,this.fontstyle=i||void 0,this.fontfamily=s||void 0,this.t=h,void 0==this.fontweight&&(this.fontweight="bold"),void 0==this.fontstyle&&(this.fontstyle="italic"),void 0==this.fontfamily&&(this.fontfamily="monospace"),ctx.fillStyle=this.color,ctx.font=this.fontstyle+" "+this.fontsize+" "+this.fontfamily,ctx.fillText(this.t,this.x,this.y)},clear=function(t,i,e,s){ctx.clearRect(t,i,e,s)},setInterval(function(){objframe++,layerframe++},120);var t,i=null;self.stopAnimation=function(){cancelAnimationFrame(i)},self.setAnimation=function(){i=requestAnimationFrame(h)};var e=0,s=0;function h(l){if(fps=1e3/self.fps||1e3/30,60==self.fps&&(self.fps=self.fps-29.9),e=l-s,ctx.imageSmoothingEnabled=!1,ctx.imageSmoothingQuality="high",i=requestAnimationFrame(h),e>fps){s+=e,ctx.save(),self.update(e),SPEED=movingSpeed,clear(0,0,gW,gH),ctx.fillStyle=t,ctx.fillRect(0,0,gW,gH),self.drawGame?self.drawGame():self.render();for(var a=0;a<particles.length;a++)(particle=particles[a]).update(),particle.draw();for(var a=0;a<snows.length;a++)if(canDraw(snows[a],camera)){var o=3*Math.random()+.03;ctx.beginPath(),ctx.fillStyle=snows[a].color,snows[a].vy=1*Math.random()+2>>0,ctx.arc(snows[a].x,snows[a].y+=snows[a].vy,snows[a].r,o,3*Math.PI),ctx.fill(),ctx.closePath()}else kill(snows,a);for(var n=0;n<rains.length;n++)ctx.save(),canDraw(rains[n],camera)?(ctx.globalAlpha=.8,rains[n].drawSprite(),ctx.scale(1,10)):kill(rains,n),ctx.restore();ctx.restore()}}return self.setAnimation(),kill=function(t,i){t.splice(i,1)},self.isHoriBorder=function(t,i){if(void 0==t.r&&void 0!==i.x){if(t.x<=i.x||t.x>=i.width-t.w||t.x>=i.w-t.w)return!0}else if(void 0!=t.r&&void 0!=i.x&&(t.x<=i.x||t.x>=i.width-t.r||t.x>=i.w-t.r))return!0;if(void 0==t.r&&void 0==i.x){if(t.x<=0||t.x>=i.width-t.w||t.x>=i.w-t.w)return!0}else if(void 0!=t.r&&void 0==i.x&&(t.x<=0||t.x>=i.width-t.r||t.x>=i.w-t.r))return!0},self.isVertiBorder=function(t,i){if(void 0==t.r&&void 0!==i.x){if(t.y<=i.y||t.y>=i.height-t.h||t.y>=i.h-t.h)return!0}else if(void 0!=t.r&&void 0!==i.y&&(t.y<=i.y||t.y>=i.height-t.r||t.x>=i.h-t.r))return!0;if(void 0==t.r&&void 0==i.y){if(t.y<=0||t.y>=i.height-t.h||t.y>=i.h-t.h)return!0}else if(void 0!=t.r&&void 0==i.y&&(t.y<=0||t.y>=i.height-t.r||t.x>=i.h-t.r))return!0},self}var Deg2Rad=Math.PI/180;function isOverlap(t,i){var e=Math.abs(i.x-(t.x+t.w/2)),s=Math.abs(i.y-(t.y+t.h/2));if(e<=i.r+i.r+t.w/2&&s<=i.r+i.r+t.h/2)return!0}function isCollide(t,i){if(t.x+t.w>=i.x&&t.x<i.x+i.w&&t.y+t.h>i.y&&t.y<i.y+i.h||t.x+t.w>i.x&&t.x<i.x+i.width&&t.y+t.h>i.y&&t.y<i.y+i.height||t.x+t.w>i.x&&t.x<i.x+i.w&&t.y+t.h+t.vy>i.y&&t.y<i.y+i.h)return!0}function isInterCirc(t,i){if(dx=t.x-i.x,dy=t.y-i.y,sumr=t.r+i.r,(distance=Math.sqrt(dx*dx+dy*dy))<=sumr)return!0}Sprite=function(t,i,e,s,h,l,a,o,n){this.x=t,this.y=i,this.w=e,this.h=s,this.vx=h,this.vy=l,this.id=n,this.rotation=o,this.flipX=!1,this.flipY=!1,this.setGravity=function(t){this.gravity=t,this.shadow},this.color=a,this.setBody=()=>{this.setGravity(3),this.y+=this.vy,this.vy+=this.gravity},this.Rotation=function(){ctx.translate(this.x,this.y),ctx.rotate(this.angle),ctx.translate(-this.x,-this.y)},this.color||(this.image=new Image),this.bullet=[],this.bullet.image=new Image,this.drawSprite=function(){for(var t=0;t<this.bullet.length;t++)this.bullet[t].image?ctx.drawImage(this.bullet[t].image,this.bullet[t].x,this.bullet[t].y,this.bullet[t].w,this.bullet[t].h):(ctx.fillStyle=this.bullet[t].color,ctx.fillRect(this.bullet[t].x,this.bullet[t].y,this.bullet[t].w,this.bullet[t].h),0==this.bullet[t].w&&0==this.bullet[t].h&&(ctx.beginPath(),ctx.arc(this.bullet[t].x,this.bullet[t].y,this.bullet[t].r,0,2*Math.PI),ctx.fill(),ctx.closePath()));if(this.flipX&&!this.rotation)for(var t=0;t<this.bullet.length;t++){if(this.bullet[t].image){ctx.save(),ctx.scale(-1,1),ctx.drawImage(this.bullet[t].image,-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].w,this.bullet[t].h),ctx.restore();return}if(this.bullet[t].w>0&&this.bullet[t].h>0){ctx.save(),ctx.scale(-1,1),ctx.fillStyle=this.bullet[t].color,ctx.fillRect(-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].w,this.bullet[t].h),ctx.restore();return}if(0==this.bullet[t].w&&0==this.bullet[t].h){ctx.beginPath(),ctx.save(),ctx.scale(-1,1),ctx.arc(-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].r,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.restore();return}}if(this.rotation&&!this.flipX&&!rotImage){ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(this.rotation),ctx.fillStyle=this.color,ctx.fillRect(-this.w/8,-this.h/2,this.w,this.h),ctx.translate(-this.x,-this.y),ctx.restore();return}if(this.rotation&&this.flipX&&!rotImage){ctx.save(),this.x=this.x-this.w/1.1,this.y=this.y-this.h/2.8,ctx.translate(this.x,this.y),ctx.scale(-1,1),ctx.rotate(this.rotation),ctx.fillStyle=this.color,ctx.fillRect(-this.w/8,-this.h/2,this.w,this.h),ctx.restore();return}if(this.angle){ctx.save(),this.Rotation(),ctx.fillStyle=this.color,ctx.fillRect(this.x,this.y,this.w,this.h),ctx.restore();return}ctx.fillStyle=this.color,ctx.fillRect(this.x,this.y,this.w,this.h),this.shadow&&(this.r=10,ctx.save(),ctx.beginPath(),ctx.fillStyle="#555",ctx.arc(this.x+this.w/2,this.y+3*this.r,this.r,0,Math.PI),ctx.fill(),ctx.closePath(),ctx.restore())},this.drawSpriteImg=function(){for(var t=0;t<this.bullet.length;t++)imSet&&ctx.drawImage(this.bullet[t].image,this.bullet[t].x,this.bullet[t].y,this.bullet[t].w,this.bullet[t].h),imSet||(ctx.fillStyle=this.bullet[t].color,this.bullet[t].w>0&&this.bullet[t].h>0?ctx.fillRect(this.bullet[t].x,this.bullet[t].y,this.bullet[t].w,this.bullet[t].h):0==this.bullet[t].w&&0==this.bullet[t].h&&(ctx.beginPath(),ctx.arc(this.bullet[t].x,this.bullet[t].y,this.bullet[t].r,0,2*Math.PI),ctx.fill(),ctx.closePath()));if(this.flipX&&!rotImage)for(var t=0;t<this.bullet.length;t++){if(imSet){ctx.save(),ctx.scale(-1,1),ctx.drawImage(this.bullet[t].image,-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].w,this.bullet[t].h),ctx.restore();return}for(var i=0;i<this.bullet.length;i++){ctx.save(),ctx.scale(-1,1),ctx.fillStyle=this.bullet[i].color,ctx.fillRect(-this.bullet[i].x-this.bullet[i].w,this.bullet[i].y,this.bullet[i].w,this.bullet[i].h),ctx.globalAlpha=1,ctx.restore();return}}for(var t=0;t<this.bullet.length;t++)if(this.bullet[t].image||(ctx.fillStyle=this.bullet[t].color,ctx.fillRect(this.bullet[t].x,this.bullet[t].y,this.bullet[t].w,this.bullet[t].h),0==this.bullet[t].w&&0==this.bullet[t].h&&(ctx.beginPath(),ctx.arc(this.bullet[t].x,this.bullet[t].y,this.bullet[t].r,0,2*Math.PI),ctx.fill(),ctx.closePath())),this.bullet[t].image&&this.bullet[t].flipX)ctx.save(),ctx.scale(-1,1),ctx.drawImage(this.bullet[t].image,-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].w,this.bullet[t].h),ctx.restore();else if(this.bullet[t].image&&this.bullet[t].flipY){ctx.save(),ctx.scale(1,-1),ctx.drawImage(this.bullet[t].image,this.bullet[t].x,-this.bullet[t].y,this.bullet[t].w,-this.bullet[t].h),ctx.restore();return}else ctx.drawImage(this.bullet[t].image,this.bullet[t].x,this.bullet[t].y,this.bullet[t].w,this.bullet[t].h);if(this.flipX&&!this.rotation)for(var t=0;t<this.bullet.length;t++)if(this.bullet[t].image)ctx.drawImage(this.bullet[t].image,-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].w,this.bullet[t].h),ctx.globalAlpha=1;else{if(this.bullet[t].w>0&&this.bullet[t].h>0){ctx.save(),ctx.scale(-1,1),ctx.fillStyle=this.bullet[t].color,ctx.fillRect(-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].w,this.bullet[t].h),ctx.restore();return}if(0==this.bullet[t].w&&0==this.bullet[t].h){ctx.beginPath(),ctx.save(),ctx.scale(-1,1),ctx.arc(-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].r,0,2*Math.PI),ctx.fill(),ctx.closePath(),ctx.restore();return}}if(this.flipX&&!rotImage){if(rotImage)return;ctx.save(),ctx.scale(-1,1),ctx.drawImage(this.image,-this.x,this.y,-this.w,this.h),ctx.globalAlpha=0,ctx.restore();return}if(!this.flipX&&imSet&&!rotImage){if(rotImage)return;ctx.drawImage(this.image,this.x,this.y,this.w,this.h)}if(this.flipY&&!this.rotation&&!rotImage&&imSet){if(rotImage)return;ctx.save(),ctx.scale(1,-1),ctx.drawImage(this.image,this.x,-this.y,this.w,-this.h),ctx.globalAlpha=0,ctx.restore();return}if(!this.flipY&&!this.rotation){if(rotImage)return;ctx.drawImage(this.image,this.x,this.y,this.w,this.h)}if(this.rotation&&(rotImage=!0),this.rotation&&(rotImage=!0),this.rotation&&this.flipX&&rotImage){this.x=this.x-this.w/1.5,this.y=this.y-this.h/2.8,ctx.save(),ctx.translate(this.x,this.y),ctx.scale(-1,-1),ctx.rotate(Math.cos(this.rotation)),ctx.drawImage(this.image,-this.w/8,-this.h/8,this.w,this.h),ctx.restore();return}if(this.rotation&&!this.flipX||!this.flipY&&rotImage){this.x=this.x-this.w/1.8,this.y=this.y-this.h/2.8,ctx.save(),ctx.translate(this.x,this.y),ctx.rotate(Math.cos(this.rotation)),ctx.drawImage(this.image,this.w/8,-this.h/8,this.w,this.h),ctx.translate(-this.x,-this.y),ctx.restore();return}},this.addBullet=function(t,i,e,s,h,l){this.obj={x:t,y:i,w:e,h:s,color:h,r:l},this.bullet.push(this.obj)},this.addBulletIm=function(t,i,e,s,h){this.obj={x:t,y:i,w:e,h:s,flipX:!1,flipY:!1},imSet=!0,this.obj.image=new Image,this.obj.image.src=h,this.bullet.push(this.obj)};var f=0;this.SpriteRot=function(){f+=8,this.drawSpriteRot(this.x,this.y,this.w,this.h,f)},this.drawSpriteRot=function(t,i,e,s,h){ctx.save(),ctx.translate(t,i),ctx.rotate(h*Deg2Rad),ctx.fillStyle=this.color,ctx.fillRect(-e/2,-s/2,e,s),ctx.restore()};var f=0;this.SpriteImgRot=function(){f+=8,imSet&&this.drawSpriteImgRot(this.image,this.x,this.y,this.w,this.h,f)},this.drawSpriteImgRot=function(t,i,e,s,h,l){return ctx.save(),ctx.translate(i,e),ctx.rotate(l*Deg2Rad),ctx.drawImage(this.image,-s/2,-h/2,s,h),ctx.restore(),this}},Circle=function(t,i,e,s,h,l,a){this.x=t,this.y=i,this.r=e,this.vx=s,this.vy=h,this.id=a,this.setGravity=function(t){this.gravity=t},this.color=l,this.bullet=[],this.bullet.image=new Image,this.setBody=()=>{this.setGravity(3),this.y+=this.vy,this.vy+=this.gravity},this.drawCirc=function(){for(b of(ctx.beginPath(),ctx.fillStyle=this.color,ctx.arc(this.x,this.y,this.r,0,2*Math.PI),ctx.fill(),ctx.closePath(),this.bullet))ctx.fillStyle=b.color,b.w>0&&b.h>0&&(ctx.fillStyle=ctx.fillRect(b.x,b.y,b.w,b.h)),0==b.w&&0==b.h&&(ctx.beginPath(),ctx.arc(b.x,b.y,b.r,0,2*Math.PI),ctx.fill(),ctx.closePath())},this.addBullet=function(t,i,e,s,h,l){this.obj={x:t,y:i,w:e,h:s,color:h,r:l},this.bullet.push(this.obj)},this.addBulletIm=function(t,i,e,s,h){this.obj={x:t,y:i,w:e,h:s,flipX:!1,flipY:!1},imSet=!0,this.obj.image=new Image,this.obj.image.src=h,this.bullet.push(this.obj)}},SpriteSheet=function(t,i,e,s,h,l,a,o,n,f,u){this.row=i,this.col=t,this.sw=e,this.sh=s,this.x=h,this.y=l,this.w=a,this.h=o,this.vx=n,this.vy=f,this.id=u,this.flipX=!1,this.flipY=!1,this.setGravity=function(t){this.gravity=t},this.setBody=()=>{this.setGravity(3),this.y+=this.vy,this.vy+=this.gravity},imSet=!0,this.image=new Image,this.bullet=[],this.bullet.image=new Image,this.drawSpriteSheet=function(){this.flipX||this.rotation||ctx.drawImage(this.image,this.col*this.sw,this.row*this.sh,this.sw,this.sh,this.x,this.y,this.w,this.h);for(var t=0;t<this.bullet.length;t++)if(this.bullet[t].image||(ctx.fillStyle=this.bullet[t].color,ctx.fillRect(this.bullet[t].x,this.bullet[t].y,this.bullet[t].w,this.bullet[t].h),0==this.bullet[t].w&&0==this.bullet[t].h&&(ctx.beginPath(),ctx.arc(this.bullet[t].x,this.bullet[t].y,this.bullet[t].r,0,2*Math.PI),ctx.fill(),ctx.closePath())),this.bullet[t].image&&this.bullet[t].flipX)ctx.save(),ctx.scale(-1,1),ctx.drawImage(this.bullet[t].image,-this.bullet[t].x,this.bullet[t].y,-this.bullet[t].w,this.bullet[t].h),ctx.restore();else if(this.bullet[t].image&&this.bullet[t].flipY){ctx.save(),ctx.scale(1,-1),ctx.drawImage(this.bullet[t].image,this.bullet[t].x,-this.bullet[t].y,this.bullet[t].w,-this.bullet[t].h),ctx.restore();return}else ctx.drawImage(this.bullet[t].image,this.bullet[t].x,this.bullet[t].y,this.bullet[t].w,this.bullet[t].h);if(this.flipY){ctx.save(),ctx.scale(1,-1),ctx.drawImage(this.image,this.col*this.sw,this.row*this.sh,this.sw,this.sh,this.x,-this.y,this.w,-this.h),ctx.restore();return}if(this.flipX){ctx.save(),ctx.scale(-1,1),ctx.drawImage(this.image,this.col*this.sw,this.row*this.sh,this.sw,this.sh,-this.x,this.y,-this.w,this.h),ctx.restore();return}this.flipY||ctx.drawImage(this.image,this.col*this.sw,this.row*this.sh,this.sw,this.sh,this.x,this.y,this.w,this.h),this.flipX||ctx.drawImage(this.image,this.col*this.sw,this.row*this.sh,this.sw,this.sh,this.x,this.y,this.w,this.h)},this.addBullet=function(t,i,e,s,h,l){this.obj={x:t,y:i,w:e,h:s,color:h,r:l},this.bullet.push(this.obj)},this.addBulletIm=function(t,i,e,s,h){this.obj={x:t,y:i,w:e,h:s,flipX:!1,flipY:!1},this.obj.image=new Image,this.obj.image.src=h,this.bullet.push(this.obj)};var c=0;this.SpriteSheetRot=function(){c+=8,this.drawSpriteSheetRot(this.image,this.col*this.sw,this.row*this.sh,this.sw,this.sh,this.x,this.y,this.w,this.h,c)},this.drawSpriteSheetRot=function(t,i,e,s,h,l,a,o,n,f){ctx.save(),ctx.translate(l,a),ctx.rotate(f*Deg2Rad),ctx.drawImage(this.image,this.col*this.sw,this.row*this.sh,this.sw,this.sh,-o/2,-n/2,o,n),ctx.restore()}};var isDrawable=!0;function tileMap(t,i,e,s,h,l,a,o,n){return this.image=new Image,this.image.src=a,this.lev=t,this.colTCount=i,this.rowTCount=t.length,this.total=s,this.ts=h,this.s=l,this.w=o,this.h=n,this.image.onload=this.drawLayer,this.drawLayer=function(){for(var t=0;t<this.rowTCount;t++)for(var i=0;i<this.colTCount;i++){var e=this.lev[t][i],a=e/s|0,o=e%s|0;(isDrawable=!(o+h/2<camera.x-h/2||tileCo+h>camera.x+camera.width+h/2))&&void 0==this.w&&void 0==this.h&&ctx.drawImage(this.image,o*h,a*h,h,h,i*l,t*l,l,l),this.w&&this.h&&ctx.drawImage(this.image,o*h,a*h,h,h,i*l,t*l,this.w,this.h)}},this}var goLeft=!1,goRight=!1;function isFollow(t,i){gap=t.x-i.x;var e=Math.abs(t.y-i.y);return gap<=20&&gap>=-20?void 0:gap<=-20&&gap>=-140&&e<=20?(goLeft=!0,goRight=!1,!0):gap>=0&&gap<=140&&e<=20?(goLeft=!1,goRight=!0,!0):void 0}function createGrid(t,i,e,s){this.gap=t,this.gW=i,this.gH=e,this.color=s,this.drawGrid=function(){for(var t=this.gap;t<this.gW;t+=this.gap)this.gW>=this.gH?(ctx.moveTo(t,0),ctx.lineTo(t,this.gW)):(ctx.moveTo(t,0),ctx.lineTo(t,this.gH));for(var i=this.gap;i<this.gH;i+=this.gap)ctx.moveTo(0,i),ctx.lineTo(this.gW,i);ctx.strokeStyle=this.color,ctx.lineWidth=1,ctx.stroke()}}function addNumber(t,i,e,s,h,l){return this.col=t,this.row=i,this.tSize=e,this.color=s,this.spaceX=h,this.spaceY=l,this.show=()=>{for(var t=0;t<=this.row;t++)for(var i=0;i<=this.col;i++){var e=i+t*this.col;ctx.font="9px arial bold",ctx.fillStyle=this.color,ctx.fillText(e,i*this.tSize+this.spaceX,t*this.tSize+this.spaceY)}},this}let loader=!1,that;function tiledMap(t,i,e){that=this,that.path=t,that.image=i=new Image,that.size=e,that.load=function(){(xhr=new XMLHttpRequest).onload=function(){4==this.readyState&&(data=JSON.parse(xhr.response),loader=!0,that.loadTileset(data))},xhr.open("get",that.path),xhr.send(!0)},that.loadTileset=function(t){for(tile of data.tilesets)that.image.src=tile.image.replace("../../","")},that.renderLayers=function(t){(t=Array.isArray(t=data.layers)?t:data.layers).forEach(that.renderLayer())},animL=[];var s=!1;return that.renderLayer=function(t){for(r=0;r<t.height;r++)for(col=0;col<t.width;col++){let i=col+r*t.width,h=t.data[i];tX=~~(--h%(tile.imagewidth/e))*e,tY=Math.floor(h/(tile.imagewidth/e))*e,dX=~~(i%t.width)*e,dY=Math.floor(i/t.width)*e,(isDrawable=!(dX+e/2<camera.x-e||dX+e/2>camera.x+camera.width+100))&&ctx.drawImage(that.image,tX,tY,e,e,dX,dY,e,e),tile.tiles&&tile.tiles.forEach((l,a)=>{if(animL.push(l),0!=h&&void 0!=animL[h]||null!=animL[h]){s=!0;var o=animL[h].animation;tIndex=layerframe%(numFrames=o.length),s&&h==l.id&&(tX=(h=o[tIndex].tileid+1)%(tile.imagewidth/e)*e,tY=Math.floor(h/(tile.imagewidth/e))*e,dX=i%t.width*e,dY=Math.floor(i/t.width)*e,(isDrawable=!(dX+e/2<camera.x-e||dX+e/2>camera.x+camera.width+100))&&ctx.drawImage(that.image,tX,tY,e,e,dX,dY,e,e))}})}var l=!1;self.objectAnimation=tileAnimation=function(i,e){for(t of(that.val=i,this.nom=e,data.layers))if("objectgroup"==t.type&&this.nom==t.name&&tile.tiles)for(let s of tile.tiles){frameIndex=objframe%(anim=s.animation).length,h=anim[frameIndex].tileid,tileColumns=tile.imagewidth/tile.tilewidth,tileRows=tile.imageheight/tile.tileheight;var h,a=tile.tileheight,o=tile.tilewidth;for(var n of t.objects)n.hasOwnProperty("gid")&&n.gid==that.val&&this.nom==t.name?l=!0:(l=!1,log(" Animation Layer's name is not defined or gidValue is incorrect in tileAnimation \n\n please read the documentation so that you may use tileAnimation correctly !!")),column=Math.floor(h%tile.columns),objrow=Math.floor(h/tile.columns),(isDrawable=!(n.x+a/2<camera.x-a)&&!(n.x+a/2>camera.x+camera.width))||(l=!1),l&&ctx.drawImage(that.image,a*column,o*objrow,a,o,n.x,n.y-o,n.width,n.height)}}},that.RenderObjectLayer=function(t){for(var i of(this.gid=t,data.layers))if("objectgroup"==i.type){for(var e of(tile.rows=tile.imageheight/tile.tileheight,i.objects))if(e.hasOwnProperty("gid")){var s=tile.imagewidth/tile.columns,h=tile.imageheight/tile.rows;this.gid=t,gid=t,(null==t||void 0==t)&&(gid=e.gid),column=Math.floor((gid-1)%tile.columns),obj2row=Math.floor(gid/tile.columns),e.x+s/2<camera.x-s||e.x+s/2>camera.x+camera.width||(isDrawable=!0),e.hasOwnProperty("gid")&&e.gid!=that.val&&!i.hasOwnProperty("properties")&&isDrawable&&ctx.drawImage(that.image,s*column,h*obj2row,s,h,e.x,e.y-h,e.width,e.height)}}},that}function canDraw(t,i){return!(t.x+t.w/2<camera.x+t.w)&&!(t.x+t.r/2<camera.x+t.r)&&!(t.x+t.w/2>camera.x+camera.width)&&!(t.x+t.r/2>camera.x+camera.width)}function tiledCollider(t,i,e){if(t.x+t.w-9.7>i.x&&t.x<i.x+i.width-9.7&&t.y+t.h-5.6>i.y&&t.y+6<i.y+i.height-15||t.x+t.w>i.x&&t.x<i.x+i.w&&t.y+t.h>i.y&&t.y<i.y+i.h)return!0;if(e&&isJumping){let s=Math.abs(t.y-i.y);if(t.x+t.w>i.x&&t.y+t.h>=i.y+i.height&&t.x<i.x+i.width&&t.y-t.h<=i.y+i.height&&s<=t.y-t.h)return!0}}var canJump=!1,Lside=!1,Rside=!1,Uside=!1,Dside=!1;function RpgFollow(t,i,e){this.gap=e;var s=Math.atan2(t.y-i.y,t.x-i.x),h=t.x-i.x,l=t.y-i.y;if(Math.sqrt(h*h+l*l)<=this.gap){switch(i.vx=Math.cos(s),i.vy=Math.sin(s),i.x+=2*i.vx,i.y+=2*i.vy,Math.sign(i.vx)){case -1:Lside=!0,Rside=!1,Uside=!1,Dside=!1;break;case 1:Rside=!0,Lside=!1,Uside=!1,Dside=!1}switch(Math.sign(i.vy)){case -1:Uside=!0,Rside=!1,Dside=!1,Lside=!1;break;case 1:Dside=!0,Rside=!1,Uside=!1,Lside=!1}}}function gameRadar(t,i){this.x=t,this.y=i;var e=new Image;e.src=this.x.toDataURL(),this.y.style.background=`url(${e.src})`,this.y.style.backgroundRepeat="no-repat",this.y.style.backgroundSize="cover"}var gameFrame=0,gameSpeed=5;class layerB{constructor(t,i,e,s,h,l){this.x=i,this.y=e,this.image=t,this.w=s,this.h=h,this.speedModifier=l,this.speed=gameSpeed*this.speedModifier}update(){this.speed=gameSpeed*this.speedModifier,this.x=gameFrame*this.speed%this.w}draw(){ctx.save(),ctx.drawImage(this.image,this.x,this.y,this.w,this.h),ctx.drawImage(this.image,this.x+this.w,this.y,this.w,this.h),ctx.restore()}}console.dir("CanvasgGameJs is running !!");var isJumping=!1;function LeftCollider(t,i,e,s){for(var h=0;h<t.length;h++)for(var l,a=0;a<t[0].length;a++)if(t[h][a]==s){l={x:tx=a*e,y:ty=h*e,w:e,h:e};let o;var n=Math.abs(i.y-l.y);l.w==i.w&&(o=n<=3.5),(l.w/i.w!=1||24==i.w)&&(o=n<=13),l.w/i.w!=1&&16==i.w&&(o=n>=18),i.x+i.w>l.x&&i.y+i.h>l.y&&i.x<l.x+l.w&&i.y<l.y+l.h&&o&&(i.x=l.x+l.w+.01)}}function RightCollider(t,i,e,s){for(var h=0;h<t.length;h++)for(var l,a=0;a<t[0].length;a++)if(tx=a*e,ty=h*e,t[h][a]==s){l={x:tx,y:ty,w:e,h:e};let o;var n=Math.abs(i.y-l.y);l.w==i.w&&(o=n<=3.5),(l.w/i.w!=1||24==i.w)&&(o=n<=13),l.w/i.w!=1&&16==i.w&&(o=n>=18),i.x+i.w>l.x&&i.y+i.h>l.y&&i.x<l.x+l.w&&i.y<l.y+l.h&&o&&(i.x=l.x-i.w-.01)}}function TopCollider(t,i,e,s){for(var h=0;h<t.length;h++)for(var l=0;l<t[0].length;l++)if(t[h][l]==s){var a={x:tx=l*e,y:ty=h*e,w:e,h:e};i.x+i.w>a.x&&i.y+i.h+i.vy>a.y&&i.x<a.x+a.w&&i.y+i.vy<a.y+a.h&&(i.y=a.y-i.h+1,i.vy=0,i.shadow=!1,JumpTime=0)}}function TopTiledCollider(t,i){for(layer of data.layers)if("objectgroup"==layer.type&&layer.name==t)for(let e of layer.objects)i.x+i.w>=e.x&&i.y+i.h+i.vy>=e.y&&i.x<=e.x+e.width&&i.y+i.vy<=e.y+e.height&&(i.y=e.y-i.h-.03,i.vy=0,i.shadow=!1,JumpTime=0)}function BottomCollider(t,i,e,s,h){if(isJumping&&!h){for(var l=0;l<t.length;l++)for(var a,o=0;o<t[0].length;o++)if(t[l][o]==s){a={x:tx=o*e,y:ty=l*e,w:e,h:e};let n=Math.abs(i.y-a.y);i.x+i.w>a.x&&i.y+i.h>=a.y+a.h/2&&i.x<a.x+a.w&&i.y-a.h+i.vy<=a.y+a.h&&n<=i.y-a.h/2&&(i.y=a.y+a.h+.01,i.vy=0,isOnAir=!1,isJumping=!1)}}}function BottomTiledCollider(t,i){if(isJumping){for(layer of data.layers)if("objectgroup"==layer.type&&layer.name==t)for(let e of layer.objects){let s=Math.abs(i.y-e.y);i.x+i.w>=e.x&&i.y+i.h>=e.y+e.height/2&&i.x<=e.x+e.width&&i.y-i.h+i.vy<=e.y+e.height&&s<=e.y-e.height/2&&(i.y=e.y+e.height-i.vy/4+.01,i.vy=0,isOnAir=!1,isJumping=!1)}}}function LeftTiledCollider(t,i){for(layer of data.layers)if("objectgroup"==layer.type&&layer.name==t)for(let e of layer.objects)isCollide(i,e)&&(i.x=i.oldX-.01)}function RightTiledCollider(t,i){for(layer of data.layers)if("objectgroup"==layer.type&&layer.name==t)for(let e of layer.objects)isCollide(i,e)&&(i.x=i.oldX+.01)}function isFlipCollide(t,i){var e=Math.abs(t.x-i.x),s=Math.abs(t.y-i.y);if(i.r){if(t.flipX&&t.x+t.w>i.x&&t.x-1.5*t.w<=i.x+1.5*i.r&&t.y+t.h>i.y&&t.y<i.y+1.8*i.r||e<i.r+t.w&&s<i.r+t.h){if(t.flipX&&t.x<i.x+i.r/1.8)return;return!0}if(!t.flpiX&&t.x+t.w/1.5>i.x&&t.x<i.x+i.r&&t.y+t.h>i.y&&t.y<i.y+i.r/1.8||e<i.r+t.w&&s<i.r+t.h)return!0}if(void 0==i.r){var e=Math.abs(t.x-i.x),s=Math.abs(t.y-i.y);if(!t.flipX&&t.x+t.w>=i.x&&t.x<=i.x+i.w&&t.y+t.h>=i.y&&t.y<=i.y+1.8*i.h)return!0;if(t.flipX&&t.x+t.w>=i.x&&t.x-1.8*t.w<=i.x+i.w&&t.y+t.h>=i.y&&t.y<=i.y+1.8*i.h){if(t.flipX&&t.x<i.x+i.w)return;return!0}}}Array.prototype.parse2D=function(t){for(var i=[],e=0;e<this.length;e+=t)i.push(this.slice(e,e+t));return i};var partImage=new Image;function Particles(t,i,e,s,h){this.name=h,this.x=t+3,this.y=i,this.size=e/1.5,this.alpha=1,this.friction=.7,this.vx=-3.5*Math.random()+-5.7*Math.random(),this.vy=(Math.random()-3.2)*Math.random()*2,this.update=function(){this.vx*=this.friction,this.x+=this.vx,this.vy+=3,this.y+=this.vy,"fire"==this.name?(this.color="#720",this.vy-=3.6,this.y+=this.vy*this.friction):"rainbow"==this.name?(this.color="#"+Math.random().toString(16).substr(-6),this.vy-=3.5,this.y+=this.vy):"waterfall"==this.name?(this.color="rgba(200,200,200,0.4)",this.vy-=.5,this.y+=this.vy*this.friction):"smoke"==this.name?(this.color="rgba(0,0,0,1)",this.vy-=3.5,this.y+=this.vy):s.color?this.color=s.color:this.color="#"+Math.random().toString(16).substr(-6)},this.draw=function(){for(let t=0;t<particles.length-1;t++){var i=particles[t];i.dx=s.x-i.x,i.dy=s.y-i.y,Math.hypot(i.dx,i.dy)>=40&&(this.alpha-=.006,this.alpha<=.5&&(particles[0]&&(this.alpha=1),kill(particles,t)))}if(s.image&&"self"==this.name){partImage.src=s.image.src,ctx.save(),ctx.globalAlpha=this.alpha,ctx.drawImage(partImage,this.x,this.y,5.5*this.size,3.5*this.size),ctx.restore();return}ctx.save(),ctx.globalAlpha=this.alpha,ctx.fillStyle=this.color,"fire"==this.name&&(ctx.shadowBlur=1.5,ctx.shadowColor="rgba(120,230,50,0.8)"),ctx.beginPath(),ctx.arc(this.x,this.y,1.9*this.size,1.8,1.7*Math.PI),ctx.fill(),ctx.restore()}}function createParticle(t,i,e){this.thesize=i,this.target=t;for(var s=0;s<i;s++)t.image&&void 0==e&&canDraw(this.target,camera)&&particles.push(new Particles(t.x+t.w/2||t.x,t.y,3*Math.random()+.3,t,e)),"fire"==e||"waterfall"==e||"smoke"==e||"rainbow"==e?canDraw(this.target,camera)&&particles.push(new Particles(t.x+t.w/2||t.x,t.y,1.5*Math.random()+.02,t,e)):canDraw(this.target,camera)&&particles.push(new Particles(t.x+t.w/2||t.x,t.y,3*Math.random()+.2,t,e));return this}function hitBox(t,i,e){var s,h=Math.abs(t.x-i.x);if(Math.hypot(h,Math.abs(t.y-i.y))<=e)return!0}function SnowEffect(t){var i=[-4,4];rand=Math.random()*length,this.space=t;for(var e={x:Math.floor(Math.random()*t.width)+.02+i[rand],y:0,s:Math.floor(1.2*Math.random())+.2,color:"rgb(255,255,255)"},s=0;s<20;s++)snows.push(new Circle(e.x,e.y,e.s,i[rand],1,e.color));for(var h=0;h<snows.length;h++)snows[h].y>t.height&&kill(snows,h),snows[h].x>t.width&&kill(snows,h)}function RainEffect(t){var i=[-3,3];rand=Math.random()*i.length,this.space=t;for(var e={x:Math.floor(Math.random()*t.width)+1,y:0,w:1.5,h:12,color:"rgba(255,255,255,0.1)"},s=0;s<30;s++)rains.push(new Sprite(e.x,e.y,e.w,e.h,i[rand],5,e.color));for(var h=0;h<rains.length;h++)rains[h].y+=15,rains[h].y>t.height&&kill(rains,h),rains[h].x>t.width&&kill(rains,h)}function isPath(t,i,e){index=0;var s=Math.abs(e.x-i.x),h=Math.abs(e.y-i.y);dx=(wp=t[pathIndex]).x-i.x;var l=Math.atan2(dy=wp.y-i.y,dx),a=Math.hypot(s,h);if(i.vx=Math.cos(l),i.vy=Math.sin(l),i.x+=2*i.vx,i.y+=2*i.vy,a>=-5&&a<=150)return!!(Math.abs(Math.round(i.x)-Math.round(wp.x))<Math.abs(2*i.vx)&&Math.abs(Math.round(i.y)-Math.round(wp.y))<Math.abs(2*i.vy))&&!!(pathIndex<t.length-1)}
